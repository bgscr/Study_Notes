# **Uniswap 学习笔记**

## **Uniswap V2: 恒定乘积模型**

### **1\. 核心机制 \- AMM**

* **全称**: Automated Market Maker (自动做市商)  
* **模型**: 采用流动性池替代传统订单簿。  
* **核心公式**: x \* y \= k  
  * x, y: 池中两种代币的数量。  
  * k: 两者乘积，在无手续费的情况下为常数。

### **2\. 合约架构**

* **Factory**: 用于创建和记录所有交易对地址。  
* **Pair**: 每个交易对都是一个独立合约，管理流动性并执行交易。

### **3\. 主要功能与函数**

#### **a. swap (交易)**

* **机制**: 采用“乐观转账”，先转出代币给用户，再验证用户转入的代币是否足够。  
* **安全**: lock 修饰符防止重入攻击。  
* **公式**: (x \+ Δx) \* (y \- Δy) \= k

#### **b. mint (添加流动性)**

* **凭证**: 获得代表份额的 LP 代币 (ERC-20)。  
* **首次添加**: LP数量 \= sqrt(amount0 \* amount1)  
* **后续添加**: LP数量 \= (amount0 / 储备量0) \* LP总供应量

#### **c. burn (移除流动性)**

* **机制**: 销毁 LP 代币，按比例取回池中资产。  
* **公式**: 取回数量 \= (销毁的LP数量 / LP总供应量) \* 池中储备量

### **4\. 其他特性**

* **手续费**: 固定 **0.3%**，计入流动性池。  
* **闪电贷**: 允许在单次原子交易中，无抵押借出池内所有代币，交易结束前必须归还本金及手续费。

## **Uniswap V3: 集中流动性模型**

### **1\. 核心机制 \- 集中流动性**

* **目的**: 解决 V2 资本效率低下的问题。  
* **机制**: 允许流动性提供者 (LP) 将资金**指定在特定的价格区间 (tick)** 内提供。  
* **优势**:  
  * 大幅提升资本效率，LP 收益更高。  
  * 交易者滑点更低。

### **2\. 核心创新**

#### **a. NFT 化的流动性头寸**

* **原因**: 每个 LP 的价格区间、资金量都不同，其头寸是独一无二的。  
* **实现**: 使用 **NFT (ERC-721)** 作为流动性凭证，取代了 V2 的 ERC-20 LP 代币。

#### **b. 多级费率**

* **机制**: 允许为交易池选择不同的手续费等级。  
* **常见费率**:  
  * **0.05%**: 稳定币对 (如 USDC/DAI)。  
  * **0.30%**: 主流资产对 (如 ETH/DAI)。  
  * **1.00%**: 高波动性或长尾资产对。

#### **c. 范围订单**

* **机制**: 通过在极窄的价格区间内提供单一资产的流动性，模拟限价单。  
* **示例**: 在 \[1.001, 1.002\] 区间提供 DAI，当价格上涨并穿过此区间时，DAI 会被自动卖成另一种资产。

## **V2 vs V3 对比总结**

| 对比维度 | Uniswap V2 (被动策略) | Uniswap V3 (主动策略) |
| :---- | :---- | :---- |
| **资本效率** | 低，资金全范围分布 | **极高**，资金按需集中 |
| **流动性凭证** | ERC-20 (同质化) | **NFT** (非同质化) |
| **手续费** | 固定 0.3% | **多级可选** (0.05% \- 1%) |
| **LP 管理** | 简单，一劳永逸 | **复杂**，需主动管理价格区间 |
| **交易者体验** | 简单，滑点可能较高 | **更优**，滑点更低，成本更少 |

### **为何 V2 依然存在？**

V3 并未完全取代 V2，V2 的**简单性**使其在以下场景仍有价值：

1. **被动投资者**: 不想主动管理资金的 LP。  
2. **长尾或高波动资产**: V2 的无限价格范围能保证其总有流动性。  
3. **协议兼容性**: 许多现有 DeFi 项目基于 V2 的 ERC-20 LP 代币构建。